{% extends 'base.html' %}


{% block title %}My Bookings{% endblock title %}

{% block content %}
    {% for booking in bookings %}
        <div class="booking">
            <img src="{{ booking.room.photo.url }}" alt="{{ booking.room.room_number }}" width="300px">
            <p>{{ booking.room.room_number }}</p>
            <p>{{ booking.room.room_type }}</p>
            <p>{{ booking.room.room_type.price }}</p>
            <p>Days staying: {{ booking.duration }} days</p>
            <p>{{ booking.status }}</p>
        </div>
    {% empty %}
        <p>You have no bookings!</p>
        <p><a href="{% url 'room_list' %}">Book now</a></p>
    {% endfor %}
     {% if bookings|length != 0 %}
        <div>
        <p>Total cost: {{ total_cost }}</p>
        <!-- Set up a container element for the button -->
        <div id="paypal-button-container"></div>
    </div>
     {% endif %}
    <a href="{% url 'room_list' %}">Go to rooms</a>
{% endblock content %}
{% block script %}
{% comment %} only include when there is booking {% endcomment %}
{% if bookings|length != 0 %}
    <!-- Include the PayPal JavaScript SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AXTapKHFnZAgEtVF7-R-mP3GoTuMCpjxzWgGF7r8V7QgLfPyRUKMWodbQ2eu06fPk5jNN-GijGjS1Ejz&currency=USD"></script>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        let amount = {{ total_cost }}
        let payment_success = "http://{{ domain }}{% url 'payment' %}"

        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            // button styles
            style: {
                color:  'blue',
                shape:  'rect',
                label:  'pay',
                height: 40
            },

            // Set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: amount
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(orderData) {
                    // Successful capture! For demo purposes:
                    // console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                    
                    var transaction = orderData.purchase_units[0].payments.captures[0];
                    alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');

                    // console.log(transaction)

                    // Replace the above to show a success message within this page, e.g.
                    // const element = document.getElementById('paypal-button-container');
                     //   element.innerHTML = '';
                     //   element.innerHTML = '<h3>Thank you for your payment!</h3>';
                    // Or go to another URL:  actions.redirect('thank_you.html');

                    let data = {
                        transID: transaction.id,
                        amount: transaction.amount.value,
                        status: transaction.status,
                        created: transaction.create_time,
                        paymentMethod: 'PayPal',
                    }

                    const sendData = ()=>{
                        fetch(payment_success, {
                            method: 'POST',
                            headers: {
                                'Content-type': 'application/json',
                                'X-CSRFToken': csrftoken,
                            },
                            body: JSON.stringify(data)
                        })
                    }

                    sendData()
                    

                    console.log(data)
                    // redirect to payment
                    actions.redirect(payment_success)
                });
            }


        }).render('#paypal-button-container');
    </script>
{% endif %}
{% endblock script %}